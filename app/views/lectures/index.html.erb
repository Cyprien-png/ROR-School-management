<% content_for :title, "Lectures Schedule" %>

<div class="space-y-6">
  <div class="flex justify-between items-center">
    <h1 class="text-2xl font-bold">Lectures Schedule</h1>
    <% if current_person.is_a?(Dean) %>
      <%= render 'shared/button', 
        text: "New Lecture", 
        icon: "fa-solid fa-plus",
        color: "green", 
        href: new_lecture_path %>
    <% end %>
  </div>

  <!-- Year and Trimester Selector -->
  <div class="bg-white shadow overflow-hidden sm:rounded-lg">
    <div class="px-4 py-5 sm:px-6 bg-indigo-50">
      <h3 class="text-lg leading-6 font-medium text-indigo-800">
        Filter Schedule
      </h3>
    </div>
    <div class="border-t border-gray-200 px-4 py-5 sm:p-6">
      <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
        <!-- Year Selector -->
        <div>
          <label class="block text-sm font-medium text-gray-700 mb-2">Academic Year</label>
          <div class="flex flex-wrap gap-2">
            <% @years.each do |year| %>
              <% year_range = "#{year.first_trimester.start_date.year}-#{year.fourth_trimester.end_date.year}" %>
              <% is_current = year.id == @selected_year&.id %>
              <%= link_to year_range, 
                lectures_path(year_id: year.id, trimester_id: params[:trimester_id]), 
                class: "px-4 py-2 rounded-md text-sm font-medium #{is_current ? 'bg-indigo-600 text-white' : 'bg-white border border-gray-300 text-gray-700 hover:bg-gray-50'}" %>
            <% end %>
          </div>
        </div>
        
        <!-- Trimester Selector -->
        <div>
          <label class="block text-sm font-medium text-gray-700 mb-2">Trimester</label>
          <div class="flex flex-wrap gap-2">
            <% @trimesters.each_with_index do |trimester, index| %>
              <% is_current = trimester.id == @selected_trimester&.id %>
              <% date_range = "#{trimester.start_date.strftime('%b %d')} - #{trimester.end_date.strftime('%b %d')}" %>
              <%= link_to "Trimester #{index + 1} (#{date_range})", 
                lectures_path(year_id: @selected_year&.id, trimester_id: trimester.id), 
                class: "px-4 py-2 rounded-md text-sm font-medium #{is_current ? 'bg-indigo-600 text-white' : 'bg-white border border-gray-300 text-gray-700 hover:bg-gray-50'}" %>
            <% end %>
          </div>
        </div>
      </div>
    </div>
  </div>

  <% if current_person.is_a?(Student) || current_person.is_a?(Teacher) %>
    <!-- Calendar view for students and teachers -->
    <div class="overflow-hidden rounded-lg border border-green-200 shadow-sm mb-6">
      <div class="bg-green-50 px-4 py-5 sm:px-6 flex items-center">
        <i class="fa-solid fa-calendar-days mr-3 text-xl"></i>
        <h3 class="text-lg font-medium leading-6 text-green-700">
          <% if @selected_trimester && @selected_year %>
            <% trimester_index = [@selected_year.first_trimester, @selected_year.second_trimester, @selected_year.third_trimester, @selected_year.fourth_trimester].compact.index(@selected_trimester) %>
            <% year_range = "#{@selected_year.first_trimester.start_date.year}-#{@selected_year.fourth_trimester.end_date.year}" %>
            Weekly Schedule - Trimester <%= trimester_index + 1 %> (<%= year_range %>)
          <% else %>
            Weekly Schedule
          <% end %>
        </h3>
      </div>
      <div class="border-t border-gray-200 bg-white px-4 py-5 sm:p-6">
        <% 
          # Filter lectures based on user role
          filtered_lectures = if current_person.is_a?(Student)
            # Show only lectures for the student's classes
            @lectures.select { |l| current_person.school_classes.include?(l.school_class) }
          elsif current_person.is_a?(Teacher)
            # Show only lectures taught by this teacher
            @lectures.select { |l| l.teacher_id == current_person.id }
          else
            @lectures
          end
        %>
        <%= render 'shared/schedule', lectures: filtered_lectures, days: ["monday", "tuesday", "wednesday", "thursday", "friday"] %>
      </div>
    </div>
  <% end %>

  <% if current_person.is_a?(Dean) %>
    <!-- List view for deans -->
    <div class="overflow-hidden rounded-lg border border-green-200 shadow-sm mb-6">
      <div class="bg-green-50 px-4 py-5 sm:px-6 flex items-center">
        <i class="fa-solid fa-list mr-3 text-xl"></i>
        <h3 class="text-lg font-medium leading-6 text-green-700">
          All Lectures
        </h3>
      </div>
      <div class="border-t border-gray-200 bg-white px-4 py-5 sm:p-6">
        <div class="overflow-x-auto shadow-md sm:rounded-lg">
          <table class="min-w-full divide-y divide-gray-200">
            <thead class="bg-gray-50">
              <tr>
                <% ["Subject", "Class", "Teacher", "Day", "Time", "Actions"].each do |header| %>
                  <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">
                    <%= header %>
                  </th>
                <% end %>
              </tr>
            </thead>
            <tbody class="bg-white divide-y divide-gray-200">
              <% @lectures.each_with_index do |lecture, index| %>
                <tr class="<%= index.odd? ? 'bg-gray-50' : '' %>">
                  <td class="px-6 py-4 whitespace-nowrap font-medium"><%= lecture.subject.name %></td>
                  <td class="px-6 py-4 whitespace-nowrap"><%= lecture.school_class.name %></td>
                  <td class="px-6 py-4 whitespace-nowrap"><%= "#{lecture.teacher.firstname} #{lecture.teacher.lastname}" %></td>
                  <td class="px-6 py-4 whitespace-nowrap"><%= lecture.week_day.capitalize %></td>
                  <td class="px-6 py-4 whitespace-nowrap"><%= lecture.start_time.strftime("%H:%M") %> - <%= lecture.end_time.strftime("%H:%M") %></td>
                  <td class="px-6 py-4 whitespace-nowrap">
                    <div class="flex space-x-2">
                      <%= render 'shared/button', 
                        text: "View", 
                        icon: "fa-solid fa-eye",
                        color: "outline-green", 
                        size: "sm",
                        href: lecture_path(lecture) %>
                        
                      <%= render 'shared/button', 
                        text: "Edit", 
                        icon: "fa-solid fa-pencil",
                        color: "outline-indigo", 
                        size: "sm",
                        href: edit_lecture_path(lecture) %>
                        
                      <%= render 'shared/button', 
                        text: "Delete", 
                        icon: "fa-solid fa-trash",
                        color: "outline-red", 
                        size: "sm",
                        method: :delete,
                        confirm: "Are you sure you want to delete this lecture?",
                        href: lecture_path(lecture) %>
                    </div>
                  </td>
                </tr>
              <% end %>
            </tbody>
          </table>
        </div>
      </div>
    </div>
  <% end %>
</div>
