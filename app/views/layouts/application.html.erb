<!DOCTYPE html>
<html>
  <head>
    <title><%= content_for?(:title) ? yield(:title) + " | School Management" : "School Management" %></title>
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="mobile-web-app-capable" content="yes">
    <%= csrf_meta_tags %>
    <%= csp_meta_tag %>

    <%= yield :head %>

    <%# Enable PWA manifest for installable apps (make sure to enable in config/routes.rb too!) %>
    <%#= tag.link rel: "manifest", href: pwa_manifest_path(format: :json) %>

    <link rel="icon" href="/icon.png" type="image/png">
    <link rel="icon" href="/icon.svg" type="image/svg+xml">
    <link rel="apple-touch-icon" href="/icon.png">

    <%# Includes all stylesheet files in app/assets/stylesheets %>
    <%= stylesheet_link_tag "tailwind", "data-turbo-track": "reload" %>
    <%= javascript_importmap_tags %>
    
    <!-- Add Font Awesome for icons -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap">
    
    <%= yield :styles %>
  </head>

  <body class="flex flex-col min-h-screen font-sans bg-gray-50">
    <% if person_signed_in? %>
      <header class="bg-indigo-600 shadow-md">
        <nav class="px-4 mx-auto max-w-7xl sm:px-6 lg:px-8">
          <div class="flex justify-between h-16">
            <div class="flex">
              <div class="flex flex-shrink-0 items-center">
                <span class="text-xl font-bold text-white">School Management</span>
              </div>
              <div class="hidden sm:ml-6 sm:flex sm:space-x-8">
                <!-- Common navigation links for all users -->
                <%= link_to "Lectures", lectures_path, class: "#{controller_name == 'lectures' ? 'border-white text-white' : 'border-transparent text-indigo-200 hover:border-indigo-300 hover:text-white'} inline-flex items-center px-1 pt-1 border-b-2 text-sm font-medium" %>
                <%= link_to "People", people_path, class: "#{['people', 'students', 'teachers'].include?(controller_name) ? 'border-white text-white' : 'border-transparent text-indigo-200 hover:border-indigo-300 hover:text-white'} inline-flex items-center px-1 pt-1 border-b-2 text-sm font-medium" %>
                
                <% if current_person.is_a?(Dean) %>
                  <!-- Dean-specific links -->
                  <%= link_to "School Classes", school_classes_path, class: "#{controller_name == 'school_classes' ? 'border-white text-white' : 'border-transparent text-indigo-200 hover:border-indigo-300 hover:text-white'} inline-flex items-center px-1 pt-1 border-b-2 text-sm font-medium" %>
                  <%= link_to "Subjects", subjects_path, class: "#{controller_name == 'subjects' ? 'border-white text-white' : 'border-transparent text-indigo-200 hover:border-indigo-300 hover:text-white'} inline-flex items-center px-1 pt-1 border-b-2 text-sm font-medium" %>
                  <%= link_to "Examinations", examinations_path, class: "#{controller_name == 'examinations' ? 'border-white text-white' : 'border-transparent text-indigo-200 hover:border-indigo-300 hover:text-white'} inline-flex items-center px-1 pt-1 border-b-2 text-sm font-medium" %>
                  <%= link_to "Grades", grades_path, class: "#{controller_name == 'grades' ? 'border-white text-white' : 'border-transparent text-indigo-200 hover:border-indigo-300 hover:text-white'} inline-flex items-center px-1 pt-1 border-b-2 text-sm font-medium" %>
                  <%= link_to "Years", years_path, class: "#{controller_name == 'years' ? 'border-white text-white' : 'border-transparent text-indigo-200 hover:border-indigo-300 hover:text-white'} inline-flex items-center px-1 pt-1 border-b-2 text-sm font-medium" %>
                <% elsif current_person.is_a?(Teacher) %>
                  <!-- Teacher-specific links -->
                  <%= link_to "My Classes", school_classes_teacher_path(current_person), class: "#{controller_name == 'school_classes' ? 'border-white text-white' : 'border-transparent text-indigo-200 hover:border-indigo-300 hover:text-white'} inline-flex items-center px-1 pt-1 border-b-2 text-sm font-medium" %>
                  <%= link_to "Examinations", examinations_path, class: "#{controller_name == 'examinations' ? 'border-white text-white' : 'border-transparent text-indigo-200 hover:border-indigo-300 hover:text-white'} inline-flex items-center px-1 pt-1 border-b-2 text-sm font-medium" %>
                  <%= link_to "Grades", grades_path, class: "#{controller_name == 'grades' ? 'border-white text-white' : 'border-transparent text-indigo-200 hover:border-indigo-300 hover:text-white'} inline-flex items-center px-1 pt-1 border-b-2 text-sm font-medium" %>
                <% elsif current_person.is_a?(Student) %>
                  <!-- Student-specific links -->
                  <%= link_to "My Classes", person_path(current_person), class: "#{controller_name == 'people' && action_name == 'show' && params[:id].to_i == current_person.id ? 'border-white text-white' : 'border-transparent text-indigo-200 hover:border-indigo-300 hover:text-white'} inline-flex items-center px-1 pt-1 border-b-2 text-sm font-medium" %>
                  <%= link_to "My Grades", grades_path, class: "#{controller_name == 'grades' ? 'border-white text-white' : 'border-transparent text-indigo-200 hover:border-indigo-300 hover:text-white'} inline-flex items-center px-1 pt-1 border-b-2 text-sm font-medium" %>
                <% end %>
              </div>
            </div>
            <div class="hidden sm:ml-6 sm:flex sm:items-center">
              <div class="relative ml-3">
                <div class="flex items-center space-x-4">
                  <div class="text-sm text-white">
                    <span class="font-medium"><%= "#{current_person.firstname} #{current_person.lastname}" %></span>
                    <span class="text-indigo-200">
                      (<%= current_person.class.name %>)
                    </span>
                  </div>
                  <%= button_to destroy_person_session_path, method: :delete, class: "bg-indigo-700 p-1 rounded-full text-white hover:text-white focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-offset-indigo-800 focus:ring-white" do %>
                    <span class="sr-only">Log out</span>
                    <i class="w-6 h-6 fas fa-sign-out-alt"></i>
                  <% end %>
                </div>
              </div>
            </div>
            <div class="flex items-center -mr-2 sm:hidden">
              <!-- Mobile menu button -->
              <button type="button" class="inline-flex justify-center items-center p-2 text-indigo-200 bg-indigo-600 rounded-md mobile-menu-button hover:text-white hover:bg-indigo-700 focus:outline-none focus:ring-2 focus:ring-inset focus:ring-white" aria-expanded="false">
                <span class="sr-only">Open main menu</span>
                <i class="block w-6 h-6 fas fa-bars"></i>
              </button>
            </div>
          </div>
        </nav>

        <!-- Mobile menu, show/hide based on menu state. -->
        <div class="hidden mobile-menu sm:hidden">
          <div class="pt-2 pb-3 space-y-1">
            <!-- Common navigation links for all users -->
            <%= link_to "Lectures", lectures_path, class: "#{controller_name == 'lectures' ? 'bg-indigo-700 text-white' : 'text-indigo-200 hover:bg-indigo-700 hover:text-white'} block pl-3 pr-4 py-2 border-l-4 border-transparent text-base font-medium" %>
            <%= link_to "People", people_path, class: "#{['people', 'students', 'teachers'].include?(controller_name) ? 'bg-indigo-700 text-white' : 'text-indigo-200 hover:bg-indigo-700 hover:text-white'} block pl-3 pr-4 py-2 border-l-4 border-transparent text-base font-medium" %>
            
            <% if current_person.is_a?(Dean) %>
              <!-- Dean-specific links -->
              <%= link_to "School Classes", school_classes_path, class: "#{controller_name == 'school_classes' ? 'bg-indigo-700 text-white' : 'text-indigo-200 hover:bg-indigo-700 hover:text-white'} block pl-3 pr-4 py-2 border-l-4 border-transparent text-base font-medium" %>
              <%= link_to "Subjects", subjects_path, class: "#{controller_name == 'subjects' ? 'bg-indigo-700 text-white' : 'text-indigo-200 hover:bg-indigo-700 hover:text-white'} block pl-3 pr-4 py-2 border-l-4 border-transparent text-base font-medium" %>
              <%= link_to "Examinations", examinations_path, class: "#{controller_name == 'examinations' ? 'bg-indigo-700 text-white' : 'text-indigo-200 hover:bg-indigo-700 hover:text-white'} block pl-3 pr-4 py-2 border-l-4 border-transparent text-base font-medium" %>
              <%= link_to "Grades", grades_path, class: "#{controller_name == 'grades' ? 'bg-indigo-700 text-white' : 'text-indigo-200 hover:bg-indigo-700 hover:text-white'} block pl-3 pr-4 py-2 border-l-4 border-transparent text-base font-medium" %>
              <%= link_to "Years", years_path, class: "#{controller_name == 'years' ? 'bg-indigo-700 text-white' : 'text-indigo-200 hover:bg-indigo-700 hover:text-white'} block pl-3 pr-4 py-2 border-l-4 border-transparent text-base font-medium" %>
            <% elsif current_person.is_a?(Teacher) %>
              <!-- Teacher-specific links -->
              <%= link_to "My Classes", school_classes_teacher_path(current_person), class: "#{controller_name == 'school_classes' ? 'bg-indigo-700 text-white' : 'text-indigo-200 hover:bg-indigo-700 hover:text-white'} block pl-3 pr-4 py-2 border-l-4 border-transparent text-base font-medium" %>
              <%= link_to "Examinations", examinations_path, class: "#{controller_name == 'examinations' ? 'bg-indigo-700 text-white' : 'text-indigo-200 hover:bg-indigo-700 hover:text-white'} block pl-3 pr-4 py-2 border-l-4 border-transparent text-base font-medium" %>
              <%= link_to "Grades", grades_path, class: "#{controller_name == 'grades' ? 'bg-indigo-700 text-white' : 'text-indigo-200 hover:bg-indigo-700 hover:text-white'} block pl-3 pr-4 py-2 border-l-4 border-transparent text-base font-medium" %>
            <% elsif current_person.is_a?(Student) %>
              <!-- Student-specific links -->
              <%= link_to "My Classes", person_path(current_person), class: "#{controller_name == 'people' && action_name == 'show' && params[:id].to_i == current_person.id ? 'bg-indigo-700 text-white' : 'text-indigo-200 hover:bg-indigo-700 hover:text-white'} block pl-3 pr-4 py-2 border-l-4 border-transparent text-base font-medium" %>
              <%= link_to "My Grades", grades_path, class: "#{controller_name == 'grades' ? 'bg-indigo-700 text-white' : 'text-indigo-200 hover:bg-indigo-700 hover:text-white'} block pl-3 pr-4 py-2 border-l-4 border-transparent text-base font-medium" %>
            <% end %>
          </div>
          <div class="pt-4 pb-3 border-t border-indigo-700">
            <div class="flex items-center px-4">
              <div class="ml-3">
                <div class="text-base font-medium text-white"><%= "#{current_person.firstname} #{current_person.lastname}" %></div>
                <div class="text-sm font-medium text-indigo-200"><%= current_person.class.name %></div>
              </div>
            </div>
            <div class="mt-3 space-y-1">
              <%= button_to "Sign out", destroy_person_session_path, method: :delete, class: "block px-4 py-2 text-base font-medium text-indigo-200 hover:text-white hover:bg-indigo-700" %>
            </div>
          </div>
        </div>
      </header>
    <% end %>

    <main class="flex-grow">
      <div class="py-6 mx-auto max-w-7xl sm:px-6 lg:px-8">
        <%= yield %>
      </div>
    </main>
    
    <footer class="bg-white">
      <div class="px-4 py-4 mx-auto max-w-7xl sm:px-6 lg:px-8">
        <p class="text-sm text-center text-gray-500">
          &copy; <%= Date.today.year %> School Management System
        </p>
      </div>
    </footer>

    <!-- Flash messages as toasts -->
    <% if notice %>
      <%= render 'shared/toast', message: notice, type: "success" %>
    <% end %>
    
    <% if alert %>
      <%= render 'shared/toast', message: alert, type: "error" %>
    <% end %>

    <script>
      document.addEventListener('DOMContentLoaded', function() {
        // Mobile menu toggle
        const mobileMenuButton = document.querySelector('.mobile-menu-button');
        const mobileMenu = document.querySelector('.mobile-menu');
        
        if (mobileMenuButton && mobileMenu) {
          mobileMenuButton.addEventListener('click', function() {
            mobileMenu.classList.toggle('hidden');
          });
        }
      });
    </script>
  </body>
</html>
